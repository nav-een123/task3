<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>body</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body>

    <div>
        <main class="flex-1 p-6">
            <div class="flex justify-between items-center px-9">
                <h1 class="text-2xl font-semibold" id="greeting"></h1>
                <button class="bg-gray-200 px-4 py-2 rounded-lg">
                    <select id="inputselect">
                        <option value="option1"> Today </option>
                        <option value="option2">Tomorrow</option>
                        <option value="option3"> Yesteraday</option>
                    </select>
                </button>
            </div>
            <div class="flex  items-center px-9">
                <span id="time" class="text-gray-500"></span>
                <p class="text-gray-500 font-bold px-2" id="date"></p>
            </div>
            <div class="flex justify-between items-center mt-20">
                <button class="border border-black-300 rounded-lg h-10 w-150 bg-slate-600 text-white py-2 px-4"
                    id="openModal">
                    create new task
                </button>
                <button class="border rounded-lg bg-green-500 h-10 w-60 mt-4 mr-80 mb-4" onclick="fetchData()">Get
                    Data</button>
            </div>
            <!-- Popup Modal -->
            <div id="modal" class="hidden fixed inset-0 flex items-center justify-center  bg-opacity-50 bg-gray-900">
                <div class="bg-white p-6 rounded-lg shadow-lg w-96">
                    <h2 class="text-lg font-bold mb-4">Create new task</h2>

                    <!-- Form -->
                    <form>

                        <!-- Date Input -->
                        <label for="dateInput" class="block text-sm font-medium text-gray-700">Select Date:</label>
                        <input type="date" id="dateInput" name="date" class="w-full p-2 mt-1 border rounded-md">

                        <!-- From Time -->
                        <label for="fromTime" class="block text-sm font-medium text-gray-700">From Time:</label>
                        <input type="time" id="fromTime" name="from_time" class="w-full p-2 mt-1 border rounded-md">

                        <!-- To Time -->
                        <label for="toTime" class="block text-sm font-medium text-gray-700 mt-3">To Time:</label>
                        <input type="time" id="toTime" name="to_time" class="w-full p-2 mt-1 border rounded-md">

                        <!-- Error Message -->
                        <p id="errorText" class="text-red-500 text-sm mt-2"></p>

                        <!-- Select Category -->
                         
                        <label for="selectInput" class="block text-sm font-medium text-gray-700 mt-3">Select
                            Category:</label>
                        <select id="selectInput" name="category" class="w-full p-2 mt-1 border rounded-md max-h-80 overflow-y-auto ">
                            <!-- <option value="Work">Work</option>
                            <option value="Diet">Diet</option>
                            <option value="List of books">List of books</option>
                            <option value="Road trip list">Road trip list</option>
                            <option value="Personal">Personal</option> -->
                        </select>
                        

                        <!-- Buttons -->
                        <div class="mt-4 flex justify-between">
                            <button id="closeModal" type="button"
                                class="px-4 py-2 bg-red-500 text-white rounded-md">Close</button>
                            <button id="submitBtn" type="button" class="px-4 py-2 bg-green-500 text-white rounded-md">
                                Submit
                            </button>

                        </div>

                    </form>
                </div>
            </div>


        </main>
        <div>
            <table class="border ml-20">

                <thead>
                    <tr class="bg-gray-200">
                        <th class="px-12 py-2 w-20">S.No</th>
                        <th class="px-4 py-2 w-40">Date</th>
                        <th class="px-4 py-2 w-20">from</th>
                        <th class="px-4 py-2 w-20">To</th>
                        <th class="px-4 py-2 w-20">select_category</th>
                        <th class="px-4 py-2 ">Edit</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                    <!-- Data will be injected here -->
                </tbody>
            </table>


        </div>
    </div>
    <script>
        function getGreeting() {
            const hours = new Date().getHours();
            if (hours < 12) return "Good Morning! ☀️";
            else if (hours < 16) return "Good Afternoon! 🌞";
            else return "Good Evening! 🌙";
        }

        // Update greeting on page load
        document.addEventListener("DOMContentLoaded", function () {
            const greetingElement = document.getElementById("greeting");
            if (greetingElement) {
                greetingElement.textContent = getGreeting();
            }
        });

        function updateDateTime() {
            const now = new Date();
            // Get day, date
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const dateString = now.toLocaleDateString(undefined, options);
            const timeString = now.toLocaleTimeString();
            // Update elements
            document.getElementById("date").textContent = dateString;
            document.getElementById("time").textContent = timeString;

        }
        // Update time every second
        setInterval(updateDateTime, 1000);
        // Initial call to set values on page load
        document.addEventListener("DOMContentLoaded", updateDateTime);

        //popup
        document.addEventListener("DOMContentLoaded", function () {
            const modal = document.getElementById("modal");
            const openModalBtn = document.getElementById("openModal");
            const closeModalBtn = document.getElementById("closeModal");
            const dateInput = document.getElementById("dateInput");
            const fromTimeInput = document.getElementById("fromTime");
            const toTimeInput = document.getElementById("toTime");
            const errorText = document.getElementById("errorText");



            function validateTime() {
                const fromTime = fromTimeInput.value;
                const toTime = toTimeInput.value;

                if (fromTime && toTime && fromTime >= toTime) {
                    errorText.textContent = "End time must be after start time!";
                    toTimeInput.classList.add("border-red-500");
                } else {
                    errorText.innerHTML += "";
                    toTimeInput.classList.remove("border-red-500");
                }
            }

            fromTimeInput.addEventListener("change", validateTime);
            toTimeInput.addEventListener("change", validateTime);

            // Open modal
            openModalBtn.addEventListener("click", () => {
                modal.classList.remove("hidden");
            });

            // Close modal
            closeModalBtn.addEventListener("click", () => {
                modal.classList.add("hidden");
            });


        });
        function closeModal() {
            document.getElementById("modal").classList.add("hidden");
        }


        // fetch post method

        async function submitData() {

            const date = document.getElementById("dateInput").value

            const from_time = document.getElementById("fromTime").value

            const to_time = document.getElementById("toTime").value

            const select_category = document.getElementById("selectInput").value


            if (!date || !from_time || !to_time || !select_category) {
                alert("Please fill out all fields.")
                return
            }


            const payload = {
                date: date,
                from_time: from_time,
                to_time: to_time,
                select_category: select_category,
            }


            try {
                const response = await fetch("http://127.0.0.1:8000/categery", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(payload)
                })


                const data = await response.json()
                if (response.ok) {
                    alert("Task Created Successfully!")
                    document.querySelector("#dateInput").value = ""
                    document.querySelector("#fromTime").value = ""
                    document.querySelector("#toTime").value = ""
                    document.querySelector("#selectInput").value = ""

                } else {
                    alert("Error: " + data.detail)
                }
            } catch (error) {
                console.error("Error:", error)
                alert("Failed to create task.")
            }
        }

        //get data
        document.addEventListener("DOMContentLoaded", fetchData);

        async function fetchData() {
            try {
                let response = await fetch("http://127.0.0.1:8000/categery/");
                let fetchresponse = await response.json();
                Table(fetchresponse.data);
            } catch (error) {
                console.error("Error fetching data:", error);
            }
        }

        function Table(data) {
            let table = document.getElementById("dataTableBody");
            table.innerHTML = data.map((item, index) => `
        <tr id="row-${item._id}" class="border-b">
            <td class="px-4 py-2">${index + 1}</td>
            <td class="px-4 py-2">${item.date}</td>
            <td class="px-4 py-2">${item.from_time}</td>
            <td class="px-4 py-2">${item.to_time}</td>
            <td class="px-4 py-2">${item.select_category}</td>
            <td class="px-4 py-2">
                <button class="bg-green-500 text-black px-3 py-1 rounded-full hover:bg-pink-600" 
                    onclick="openUpdateModal('${item._id}', '${item.date}', '${item.from_time}', '${item.to_time}', '${item.select_category}')">
                    Update
                </button>
                <button class="bg-green-500 text-black px-3 py-1 rounded-full hover:bg-red-600 ml-2" 
                    onclick="deleteTask('${item._id}')">
                    Delete
                </button>
            </td>
        </tr>
    `).join('');
        }


        // to delete the task
        async function deleteTask(taskId) {
            try {
                const response = await fetch(`http://127.0.0.1:8000/categery/${taskId}`, {
                    method: 'DELETE',
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const result = await response.json();
                // Optionally, remove the task from the UI
                const row = document.getElementById(`row-${taskId}`);
                if (row) {
                    row.remove();
                }
            } catch (error) {
                console.error('Error deleting task:', error);
            }
        }

        // Open Modal for Creating a New Task (Clears Fields)
        document.getElementById("openModal").addEventListener("click", function () {
            document.getElementById("dateInput").value = "";
            document.getElementById("fromTime").value = "";
            document.getElementById("toTime").value = "";
            document.getElementById("selectInput").value = "";

            const submitBtn = document.getElementById("submitBtn");
            submitBtn.textContent = "Create Task";
            submitBtn.setAttribute("onclick", "submitData()");

            document.getElementById("modal").classList.remove("hidden");
        });

        // Open Modal for Updating a Task (Prefills Fields)
        function openUpdateModal(taskId, date, fromTime, toTime, category) {
            document.getElementById("dateInput").value = date;
            document.getElementById("fromTime").value = fromTime;
            document.getElementById("toTime").value = toTime;
            document.getElementById("selectInput").value = category;

            const submitBtn = document.getElementById("submitBtn");
            submitBtn.textContent = "Update Task";
            submitBtn.setAttribute("onclick", `updateTask('${taskId}')`);

            document.getElementById("modal").classList.remove("hidden");
        }


        // Update Task in Backend
        async function updateTask(taskId) {
            const updatedTask = {
                date: document.getElementById("dateInput").value,
                from_time: document.getElementById("fromTime").value,
                to_time: document.getElementById("toTime").value,
                select_category: document.getElementById("selectInput").value,
            };

            try {
                const response = await fetch(`http://127.0.0.1:8000/categery/${taskId}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(updatedTask)
                });

                const result = await response.json();
                if (response.ok) {
                    alert("Task Updated Successfully!");
                    document.getElementById("modal").classList.add("hidden");
                    fetchData();  // Refresh table
                } else {
                    alert("Error: " + result.detail);
                }
            } catch (error) {
                console.error("Error updating task:", error);
                alert("Failed to update task.");
            }
        }


        //select option

        document.addEventListener("DOMContentLoaded", function () {
            let apiUrl = "http://127.0.0.1:8000/task"; // Ensure backend is running
            let listContainer = document.getElementById("selectInput");
            let existingCategories = new Set(); // Track existing items to prevent duplicates
            let selectInput = document.getElementById("selectInput"); // Reference to the select element

            function fetchAndUpdate() {
                fetch(apiUrl)
                    .then(response => response.json())
                    .then(responseData => {
                        console.log("API Response:", responseData); 

                        let categories = responseData?.data;

                        if (!Array.isArray(categories)) {
                            console.error("Expected an array but got:", categories);
                            return;
                        }

                        categories.forEach(category => {
                            if (!existingCategories.has(category.name)) { // Only add new items
                                let listItem = document.createElement("li");
                                listItem.className = "flex items-center justify-between hover:bg-red-100 rounded-lg h-15 w-100 py-2";
                                listItem.innerHTML = `
                            <span class="flex items-center gap-2 ml-6 font-semibold ">${category?.name}</span>
                            <div>
                                <button class="mr-10" onclick="updateCategory('${category._id}', this)"> ✏️</button>
                                <button class="mr-40" onclick="deleteCategory('${category._id}', this)">🗑️</button>
                            </div>
                           
                        `;

                                listContainer.appendChild(listItem);
                                existingCategories.add(category.name);

                                // Add the category to the select dropdown
                                let option = document.createElement("option");
                                option.value = category.name;
                                option.textContent = category.name;
                                selectInput.appendChild(option);
                            }
                        });
                    })
                    .catch(error => {
                        console.error("Error fetching categories:", error);
                    });
            }

            fetchAndUpdate(); // Initial call
            setInterval(fetchAndUpdate, 10000); // Fetch new data every 10 seconds
        });



    </script>


</body>

</html>